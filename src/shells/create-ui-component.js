const fs = require('fs');
const path = require('path');
const { exec } = require('child_process');

const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  cyan: '\x1b[36m',
  magenta: '\x1b[35m',
  bold: '\x1b[1m',
};

const spinnerFrames = ['|', '/', '-', '\\'];

function colorText(text, color, bold = false) {
  return (bold ? colors.bold : '') + (colors[color] || '') + text + colors.reset;
}

function showSpinner(message, icon = 'â³', color = 'cyan') {
  let i = 0;
  process.stdout.write('\n');

  const interval = setInterval(() => {
    const frame = spinnerFrames[i % spinnerFrames.length];
    const line = `${frame} ${icon} ${message}   `;
    process.stdout.write('\r' + colorText(line, color, true));
    i++;
  }, 120);

  return interval;
}

function stopSpinner(interval, success = true, message = '') {
  clearInterval(interval);

  process.stdout.write('\r' + ' '.repeat(process.stdout.columns || 80) + '\r');

  const icon = success ? 'âœ”ï¸' : 'âŒ';
  const color = success ? 'green' : 'red';
  process.stdout.write(colorText(`${icon} ${message}`, color, true) + '\n');
}

const componentName = process.argv[2];
if (!componentName) {
  console.error(colorText('âŒ Please provide component name', 'red', true));
  process.exit(1);
}

const project = 'base';
const componentPath = `src/app/ui-components/${componentName}`;
const tsFile = path.join(componentPath, `${componentName}.component.ts`);

const command = `ng g c ui-components/${componentName} --prefix=${project}`;

const spinner = showSpinner('Generating your component...', 'ðŸš€', 'magenta');
const startTime = Date.now();
const minDuration = 5000;

exec(command, (error, stdout, stderr) => {
  const duration = Date.now() - startTime;

  const finish = (success, msg) => {
    stopSpinner(spinner, success, msg);

    if (!success) {
      console.error(stderr || error);
      process.exit(1);
    }

    if (fs.existsSync(tsFile)) {
      let content = fs.readFileSync(tsFile, 'utf8');

      content = `// Auto-generated by script\n${content}`;

      fs.writeFileSync(tsFile, content, 'utf8');
    }
  };

  if (duration >= minDuration) {
    finish(!error, 'Component generated successfully! Happy coding! ðŸŽ‰');
  } else {
    setTimeout(() => {
      finish(!error, 'Component generated successfully! Happy coding! ðŸŽ‰');
    }, minDuration - duration);
  }
});
